(function ($) {
	$.fn.extend({
	    "cloudZoom": function () {
	    		var cloudZoom = this.on("mouseenter", ".cloud-zoom-item", onswitch);
	    		var clouldZoomBig = $(".clould-zoom-big", cloudZoom)
			var clouldZoomImg = $("img", clouldZoomBig);
			var clouldZoomView = $(".clould-zoom-view", cloudZoom);
			var clouldZoomBird = $(".clould-zoom-bird", cloudZoom);
			var clouldZoomList = $(".clould-zoom-list", cloudZoom);
			var coludZoomPrev = $(".colud-zoom-prev", cloudZoom).bind("mouseenter", onprev).bind("mouseleave", oncancelscroll);
			var coludZoomNext = $(".colud-zoom-next", cloudZoom).bind("mouseenter", onnext).bind("mouseleave", oncancelscroll);
			var clouldZoomBirdOutter = $(".clould-zoom-bird-outter", cloudZoom).bind("mouseenter", onmouseenter);
			
			var bigOffset = null;
			var zoom =  1;
			var imgOffsetX = 0;
			var imgOffsetY = 0;
			
			function onswitch() {
				var $this = $(this);
				$(".colud-zoom-selected").removeClass("colud-zoom-selected");
				$this.addClass("colud-zoom-selected")
				var ref = $this.attr("ref");
				clouldZoomImg.attr("src", this.getAttribute("ref"));
				clouldZoomView.css("background-image", "url("+ ref +")");
			}
			
			function onmouseenter(evt) {
				clouldZoomBirdOutter.bind("mousemove", onmousemove);
				clouldZoomBirdOutter.bind("mouseleave", onmouseleave);
				bigOffset = clouldZoomBig.offset();
				var offset = getOffset(evt);
				clouldZoomBird.css("left", offset.x + "px");
				clouldZoomBird.css("top", offset.y + "px");
				
				var bigWidth = clouldZoomBig.width();
				var bigHeight = clouldZoomBig.height();
				var viewWidth = clouldZoomView.width();
				var birdWidth = clouldZoomBird.width();
				var imgWidth = clouldZoomImg.width();
				var imgHeight = clouldZoomImg.height();
				var zoomWidth = null;
				var zoomHeight = null;
				zoom = viewWidth / birdWidth;
				if(imgWidth > imgHeight) {
					zoomWidth = imgWidth * zoom;
					zoomHeight = zoomWidth * imgHeight / imgWidth;
				} else {
					zoomHeight = imgHeight * zoom;
					zoomWidth = zoomHeight * imgWidth / imgHeight;
				}
				imgOffsetX = (bigWidth - imgWidth) * 0.5;
				imgOffsetY = (bigHeight - imgHeight) * 0.5;
				clouldZoomView.css("background-size", zoomWidth + "px " + zoomHeight + "px");
				clouldZoomView.css("background-position", ((-offset.x + imgOffsetX) * zoom) + "px " + ((-offset.y + imgOffsetY) * zoom) + "px");
				
				clouldZoomBird.show();
				clouldZoomView.fadeIn();
			}
			
			function onmousemove(evt) {
				var offset = getOffset(evt);
				clouldZoomBird.css("left", offset.x + "px");
				clouldZoomBird.css("top", offset.y + "px");
				clouldZoomView.css("background-position", ((-offset.x + imgOffsetX) * zoom) + "px " + ((-offset.y + imgOffsetY) * zoom) + "px");
				
			}
			
			function onmouseleave(evt) {
				clouldZoomBirdOutter.unbind("mousemove", onmousemove);
				clouldZoomBirdOutter.unbind("mouseleave", onmouseleave);
				clouldZoomBird.hide();
				clouldZoomView.fadeOut();
			}
			
			function getOffset(evt) {
				var birdWidth = clouldZoomBird.width();
				var birdHeight = clouldZoomBird.height();
				var bigWidth = clouldZoomBig.width();
				var bigHeight = clouldZoomBig.height();
			
				var x = evt.pageX - bigOffset.left - birdWidth * 0.5;
				var y = evt.pageY - bigOffset.top - birdHeight * 0.5;
				if(x < 0) {
					x = 0;
				} else if(x > bigWidth - birdWidth) {
					x = bigWidth - birdWidth;
				}
				if(y < 0) {
					y = 0;
				} else if(y > bigHeight - birdHeight) {
					y = bigHeight - birdHeight;
				}
				return { x: x, y: y };
			}
			
			var originLeft = clouldZoomList.position().left;
			var scrollHandler = 0;
			var childrenCount = clouldZoomList.children().length - 1;
			var blockWidth = clouldZoomList.children().outerWidth(true);
			var maxLeft = (childrenCount - 7) * blockWidth;
			
			if(childrenCount > 6) {
				coludZoomPrev.show();
				coludZoomNext.show();
			}
			
			function onprev() {
				window.clearTimeout(scrollHandler);
				var left = parseInt(clouldZoomList.position().left, 10);
				if(left < originLeft) {
					clouldZoomList.animate({"left": left + blockWidth + "px"}, 150);
					scrollHandler = window.setTimeout(onprev, 200);
				} else {
					coludZoomPrev.addClass("cloud-zoom-disabled");
				}
				coludZoomNext.removeClass("cloud-zoom-disabled");
			}
			
			function onnext() {
				window.clearTimeout(scrollHandler);
				var left = parseInt(clouldZoomList.position().left, 10);
				if(left > -maxLeft) {
					clouldZoomList.animate({"left": left - blockWidth + "px"}, 150);
					scrollHandler = window.setTimeout(onnext, 200);
				} else {
					coludZoomNext.addClass("cloud-zoom-disabled");
				}
				coludZoomPrev.removeClass("cloud-zoom-disabled");
			}
				
			function oncancelscroll() {
				window.clearTimeout(scrollHandler);
			}
            return this;
        }
    });
})(jQuery);